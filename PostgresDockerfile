FROM ubuntu/postgres:12-20.04_beta

RUN apt-get update -y
RUN apt-get upgrade -y

RUN apt-get install -y postgresql-contrib libpq-dev
RUN apt-get install -y postgis
RUN apt-get install -y postgresql-12-postgis-3
RUN apt-get install -y gdal-bin libspatialindex-dev libgeos-dev libproj-dev

RUN apt-get install -y python3 python3-pip python3-dev

RUN psql -d colouringlondon -U dockeruser -c "create extension postgis;"
RUN psql -d colouringlondon -U dockeruser -c "create extension pgcrypto;"
RUN psql -d colouringlondon -U dockeruser -c "create extension pg_trgm;"

# RUN mkdir /colouring-london
# COPY app /colouring-london/app
# COPY migrations /colouring-london/migrations
# COPY etl /colouring-london/etl

# RUN ls ./colouring-london/migrations/*.up.sql 2>/dev/null | while read -r migration; do psql -d colouringlondon < $migration; done;

# RUN pip install --upgrade pip
# RUN pip install --upgrade setuptools wheel
# RUN pip install -r ./colouring-london/etl/requirements.txt

# RUN python ./colouring-london/etl/get_test_polygons.py
# RUN ./colouring-london/etl/load_geometries_cl.sh ./
# RUN psql -d colouringlondon -U dockeruser < ./colouring-london/app/migrations/002.index-geometries.up.sql
# RUN ./create_building_records_cl.sh
# RUN psql -d colouringlondon -U dockeruser < ./colouring-london/app/migrations/003.index-buildings.up.sql
# RUN ls ./colouring-london/migrations/*.up.sql 2>/dev/null | while read -r migration; do psql -d colouringlondon < $migration; done;